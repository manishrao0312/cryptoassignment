<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ECC Live Demo</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/html5-qrcode@2.3.9/minified/html5-qrcode.min.js"></script>
<script>
let bobKeys = {};

async function loadBobKeys() {
    const res = await fetch("/bob_keys");
    bobKeys = await res.json();
    document.getElementById("bobPublic").innerText = bobKeys.public_key;
    document.getElementById("bobPrivate").innerText = bobKeys.private_key;
}

async function encryptMessage() {
    const message = document.getElementById("aliceMessage").value;
    if (!message) return alert("Enter message");

    const res = await fetch("/encrypt", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message })
    });
    const data = await res.json();

    document.getElementById("qrImage").src = "data:image/png;base64," + data.qr_image;
    document.getElementById("qrImage").classList.remove("hidden");

    document.getElementById("encryptionDetails").innerText = 
`Bob Public Key:\n${data.bob_public_key}\n
Ephemeral Public Key (Alice):\n${data.ephemeral_public_key}\n
AES Key (Derived):\n${data.aes_key_demo}\n
Payload JSON:\n${JSON.stringify(data.payload, null, 2)}`;

    document.getElementById("payloadInput").value = JSON.stringify(data.payload, null, 2);
}

function copyPayload() {
    const text = document.getElementById("payloadInput").value;
    navigator.clipboard.writeText(text)
        .then(() => alert("Encrypted payload copied!"))
        .catch(() => alert("Copy failed!"));
}

function startScanner() {
    const qrCodeRegionId = "qr-reader";
    document.getElementById(qrCodeRegionId).style.display = "block";

    const html5QrcodeScanner = new Html5QrcodeScanner(
        qrCodeRegionId,
        { fps: 10, qrbox: 250 }
    );

    html5QrcodeScanner.render(async (qrCodeMessage) => {
        try {
            const payload = JSON.parse(qrCodeMessage);
            await decryptMessage(payload);
            html5QrcodeScanner.clear();
            document.getElementById(qrCodeRegionId).style.display = "none";
        } catch (e) {
            console.error("QR scan error:", e);
        }
    });
}

async function decryptMessage(payload) {
    const res = await fetch("/decrypt", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ payload })
    });
    const data = await res.json();
    document.getElementById("decryptedMessage").innerText = data.message;
}

async function decryptManual() {
    try {
        const payload = JSON.parse(document.getElementById("payloadInput").value);
        decryptMessage(payload);
    } catch {
        alert("Invalid JSON!");
    }
}

window.onload = loadBobKeys;
</script>
</head>
<body class="bg-gray-900 text-white p-6 font-sans flex flex-col items-center min-h-screen">

<h1 class="text-4xl font-bold mb-6">ECC Live Demo: Alice & Bob</h1>

<div class="w-full max-w-xl bg-gray-800 p-6 rounded-2xl shadow-xl mb-8">
<h2 class="text-2xl font-semibold mb-2">Bob (Receiver) Keys</h2>
<div class="bg-gray-700 p-3 rounded-lg mb-2">
<strong>Public Key:</strong>
<pre id="bobPublic" class="text-blue-400 overflow-x-auto break-words"></pre>
</div>
<div class="bg-gray-700 p-3 rounded-lg">
<strong>Private Key (Demo only!):</strong>
<pre id="bobPrivate" class="text-red-400 overflow-x-auto break-words"></pre>
</div>
</div>

<div class="w-full max-w-xl bg-gray-800 p-6 rounded-2xl shadow-xl mb-8">
<h2 class="text-2xl font-semibold mb-2">Alice (Sender)</h2>
<textarea id="aliceMessage" rows="3" placeholder="Type message here..."
class="w-full p-3 rounded-lg bg-gray-700 mb-2"></textarea>
<button onclick="encryptMessage()" class="w-full py-2 bg-purple-600 hover:bg-purple-700 rounded-lg font-bold mb-2">Encrypt & Generate QR</button>
<button onclick="copyPayload()" class="w-full py-2 bg-yellow-500 hover:bg-yellow-600 rounded-lg font-bold mb-4">Copy Encrypted Payload JSON</button>
<img id="qrImage" src="" class="mx-auto hidden rounded-lg border-4 border-purple-500 mb-4" style="width:300px;height:300px;"/>
<textarea id="payloadInput" rows="6" placeholder="Encrypted payload JSON..." class="w-full p-2 rounded-lg bg-gray-700 mb-2"></textarea>
<div class="bg-gray-700 p-3 rounded-lg overflow-x-auto">
<pre id="encryptionDetails" class="text-sm text-purple-300 whitespace-pre-wrap break-words"></pre>
</div>
</div>

<div class="w-full max-w-xl bg-gray-800 p-6 rounded-2xl shadow-xl">
<h2 class="text-2xl font-semibold mb-2">Bob Scan QR & Decrypt / Paste Payload</h2>
<div id="qr-reader" style="width:100%;height:300px;display:block;" class="mb-4 rounded-lg overflow-hidden"></div>
<button onclick="startScanner()" class="w-full py-2 bg-green-600 hover:bg-green-700 rounded-lg font-bold mb-4">Start QR Scanner</button>
<button onclick="decryptManual()" class="w-full py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-bold mb-4">Decrypt Pasted Payload</button>
<div class="bg-gray-700 p-3 rounded-lg">
<strong>Decrypted Message:</strong>
<p id="decryptedMessage" class="text-purple-400 break-words mt-1"></p>
</div>
</div>

</body>
</html>
